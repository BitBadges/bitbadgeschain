syntax = "proto3";
package badges;

import "google/protobuf/any.proto";
import "badges/transfers.proto";
import "badges/balances.proto";
import "badges/permissions.proto";
import "badges/metadata.proto";
import "badges/timelines.proto";
import "badges/approvals.proto";
import "badges/user_balance_store.proto";
import "gogoproto/gogo.proto";

option go_package = "github.com/bitbadges/bitbadgeschain/x/badges/types";

/* 
  A TokenCollection is the top-level object for a collection of tokens. 
  It defines everything about the collection, such as the manager, metadata, etc.

  All collections are identified by a collectionId assigned by the blockchain, which is a uint64 that increments (i.e. the first collection has ID 1).

  All collections can have a manager who is responsible for managing the collection and can be granted certain admin
  permissions, such as the ability to mint new tokens.

  Certain fields are timeline-based, which means they may have different values at different block heights. 
  We fetch the value according to the current time.
  For example, we may set the manager to be Alice from Time1 to Time2, and then set the manager to be Bob from Time2 to Time3.

  Collections may have different balance types: standard vs. off-chain - indexed vs. inherited.vs off-chain - non-indexed vs non-public.
  
  See documentation for more details.
*/
message TokenCollection {
  // The unique identifier for this collection. This is assigned by the blockchain. First collection has ID 1.
  string collectionId = 1 [(gogoproto.customtype) = "Uint", (gogoproto.nullable) = false];
  
  // The metadata for the collection itself, which can vary over time.
  repeated CollectionMetadataTimeline collectionMetadataTimeline = 2;
  
  // The metadata for each token in the collection, also subject to changes over time.
  repeated TokenMetadataTimeline tokenMetadataTimeline = 3;
  
  // An arbitrary field that can store any data, subject to changes over time.
  repeated CustomDataTimeline customDataTimeline = 4;
  
  // The address of the manager of this collection, subject to changes over time.
  repeated ManagerTimeline managerTimeline = 5;
  
  // Permissions that define what the manager of the collection can do or not do.
  CollectionPermissions collectionPermissions = 6;
  
  // Transferability of the collection for collections with standard balances, subject to changes over time.
  // Overrides user approvals for a transfer if specified.
  // Transfer must satisfy both user and collection-level approvals.
  // Only applicable to on-chain balances.
  repeated CollectionApproval collectionApprovals = 7;
  
  // Standards that define how to interpret the fields of the collection, subject to changes over time.
  repeated StandardsTimeline standardsTimeline = 8;

  // Whether the collection is archived or not, subject to changes over time.
  // When archived, it becomes read-only, and no transactions can be processed until it is unarchived.
  repeated IsArchivedTimeline isArchivedTimeline = 9;

  // The default store of a balance / approvals for a user, upon genesis.
  UserBalanceStore defaultBalances = 10;

  // The user or entity who created the collection.
  string createdBy = 11;

  // The valid token IDs for this collection.
  repeated UintRange validTokenIds = 12;

  //The generated address of the collection. Also used to escrow Mint balances.
  string mintEscrowAddress = 13;

  // The IBC wrapper (sdk.coin) paths for the collection.
  repeated CosmosCoinWrapperPath cosmosCoinWrapperPaths = 14;

  // Collection-level invariants that cannot be broken.
  // These are set upon genesis and cannot be modified.
  CollectionInvariants invariants = 15;
}

message CosmosCoinWrapperPath {
  // The BitBadges address associated with this wrapper path. Used for routing and identifying the wrapper.
  string address = 1;
  // The denomination (denom) to be used for the wrapped coin or the alias denom.
  string denom = 2;
  // The token balances that correspond to this wrapper path. Defines how much you have to wrap to get x1 of corresponding base level unit.
  repeated Balance balances = 3;
  // The symbol for the wrapped coin (e.g., "BADGE", "NFT"). Used for display purposes. Note that this may not be the default.
  string symbol = 4;
  // Denomination units for the wrapped coin. Defines how the coin can be displayed with different
  // decimal places and symbols (e.g., base unit, display unit). You can specify which is the default display unit (base level or one of these).
  repeated DenomUnit denomUnits = 5;
  // If true, allows this wrapper path to be used with any valid token ID in the collection via an {id} placeholder.
  bool allowOverrideWithAnyValidToken = 6;
  // If true, allows tokens to be wrapped into Cosmos SDK coins. When false, this path is just an alias
  bool allowCosmosWrapping = 7;
}

message CosmosCoinBackedPath {
  // The address associated with this backed path. Used for routing and escrowing IBC tokens.
  string address = 1;
  // The IBC denomination of the backing token. This identifies which IBC token backs the badges
  // (e.g., "ibc/..." or "ubadge"). Conversion is Balances[] = sdk.Coins([{ amount: ibcAmount, denom: ibcDenom }])
  string ibcDenom = 2;
  // The token balances that correspond to this backed path. Defines which token IDs and amounts
  // are backed by the IBC tokens. Conversion is Balances[] = sdk.Coins([{ amount: ibcAmount, denom: ibcDenom }])
  repeated Balance balances = 3;
  // The amount of IBC tokens that back the tokens. This defines the exchange rate or backing amount
  // for the tokens in this path. Conversion is Balances[] = sdk.Coins([{ amount: ibcAmount, denom: ibcDenom }])
  string ibcAmount = 4 [(gogoproto.customtype) = "Uint", (gogoproto.nullable) = false];
}

message DenomUnit {
  // The number of decimal places for this unit. Defines the precision of the unit.
  string decimals = 1 [(gogoproto.customtype) = "Uint", (gogoproto.nullable) = false];
  // The symbol for this unit (e.g., "BADGE", "nBADGE"). Used for display purposes.
  string symbol = 2;
  // If true, this is the default display unit. Only one unit should be marked as the default display unit.
  // This unit will be used by default when displaying the coin amount. If none are marked default, we use the base level.
  bool isDefaultDisplay = 3;
}

// CollectionInvariants defines the invariants that apply to a collection.
message CollectionInvariants {
  // If true, all ownership times must be full ranges [{ start: 1, end: GoMaxUInt64 }].
  // This prevents time-based restrictions on token ownership.
  bool noCustomOwnershipTimes = 1;
  
  // Maximum supply per token ID. If set, no balance can exceed this amount.
  // This prevents any single token ID from having more than the specified supply.
  string maxSupplyPerId = 2 [(gogoproto.customtype) = "Uint", (gogoproto.nullable) = false];
  
  // The IBC backed (sdk.coin) path for the collection. Only one path is allowed.
  CosmosCoinBackedPath cosmosCoinBackedPath = 3;
  
  // If true, disallows any collection approvals that have overridesFromOutgoingApprovals or overridesToIncomingApprovals set to true.
  // This prevents forceful transfers that bypass user-level approvals.
  // This only applies to transfers where the from address does not equal "Mint".
  bool noForcefulPostMintTransfers = 4;
  
  // If true, disallows pool creation with this collection's assets.
  // When true, any attempt to create a pool with badges assets from this collection will fail.
  bool disablePoolCreation = 5;
}
